{% extends "index.html" %} {%block dashboard %}
<div class="xl:container xl:mx-auto">

  <div class="px-0 md:px-0 pb-4">
    <div class="flex items-center justify-between gap-4 flex-wrap mb-2">
      <h2 class="text-xl md:text-2xl font-semibold flex items-center gap-2 [&_svg]:size-4">
        Welcome, {{ user.username }}
      </h2>
    </div>
  </div>

  <!-- table -->
  <div class="uploaded-data border border-muted rounded-md bg-background p-4 shadow-sm">
    <!-- table container header section -->
    <div class="flex items-center justify-between gap-4 flex-wrap mb-6">
      <h2 class="text-xl md:text-2xl font-semibold flex items-center gap-2 [&_svg]:size-4">
        <span class="rounded-full p-1 border border-border text-primary">
          <i data-lucide="circle-user-round"></i>
        </span>
        Doctor's Data
      </h2>

    </div>

    <div class="my-container ">
        <!-- filter section -->
        <div class="table-actions flex justify-between items-center flex-wrap gap-5 mb-6">

            <!-- left section -->
          <div class="left-actions flex items-center flex-wrap gap-4">
            <!-- custom select -->
            <div class="custom-select">
              <button
                class="select-button button button--md button--outline flex-1 w-full"
                type="button"
                id="columnToggle"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                <span class="selected-value">Show/Hide Column</span>
                <i data-lucide="chevron-down"></i>
              </button>
              <ul class="select-dropdown hidden" aria-labelledby="columnToggle">
                <li>
                  <label class="dropdown-item"
                    ><input type="checkbox" checked data-column="0" /> #</label
                  >
                </li>
                <li>
                  <label class="dropdown-item"
                    ><input type="checkbox" checked data-column="1" /> Dr.Rpl ID</label
                  >
                </li>
                <li>
                  <label class="dropdown-item"
                    ><input type="checkbox" checked data-column="2" /> Dr.
                    Name</label
                  >
                </li>
                <li>
                  <label class="dropdown-item"
                    ><input type="checkbox" checked data-column="3" /> Speciality
                    </label
                  >
                </li>
                <li>
                  <label class="dropdown-item"
                    ><input type="checkbox" checked data-column="4" /> Designation
                    </label
                  >
                </li>
                <li>
                  <label class="dropdown-item"
                    ><input type="checkbox" checked data-column="5" />
                    Chamber List</label
                  >
                </li>
                
              </ul>
            </div>

            <form method="get" >
              <input
                type="search"
                name="search"
                class="input"
                placeholder="Search..."
                value="{{ search_query }}"
              />
            </form>
          </div>

          <!-- right section -->
          <div class="right-actions flex items-center justify-center md:justify-start flex-wrap gap-4">
            <a href="{% url 'dop_export' %}" class="button button--md flex-1 button--primary"><i data-lucide="download"></i> Download</a>
            <button class="button button--md flex-1 button--secondary copy-table-data" id="copyTableData" onclick="copyTableData('doctorTable')">
              <i data-lucide="copy"></i> Copy
            </button>
            <a href="{% url 'dop_export' %}" class="button button--md flex-1 button--outline"><i data-lucide="file"></i> Excel</a> 
          </div>
        </div>

        <!-- table -->
          <div class="table-container">
            <table class="table" id="doctorTable">
              <thead class="table-head">
                  <tr class="table-row">
                      <th class="table-head">#</th>
                      <th class="table-head">
                          <a class="button button--md button--ghost flex" href="?sort=dr_id&direction={% if sort == 'dr_id' and direction == 'asc' %}desc{% else %}asc{% endif %}">
                          Dr. RPL ID
                          {% if sort == 'dr_id' %}
                              <i data-lucide="chevron-{% if direction == 'asc' %}up{% else %}down{% endif %}"></i>
                          {% else %}
                              <i data-lucide="chevrons-up-down"></i>
                          {% endif %}
                          </a>
                      </th>
                      <th class="table-head">
                          <a class="button button--md button--ghost flex" href="?sort=dr_name&direction={% if sort == 'dr_name' and direction == 'asc' %}desc{% else %}asc{% endif %}">
                          Dr. Name
                          {% if sort == 'dr_name' %}
                              <i data-lucide="chevron-{% if direction == 'asc' %}up{% else %}down{% endif %}"></i>
                          {% else %}
                              <i data-lucide="chevrons-up-down"></i>
                          {% endif %}
                          </a>
                      </th>
                      <th class="table-head">
                          Speciality
                      </th>
                      <th class="table-head">
                          Designation
                      </th>
                      <th class="table-head">Chamber List</th>
                  </tr>
              </thead>
              <tbody class="table-body">
                  {% for item in data %}
                  <tr class="table-row">
                      <td class="table-cell">{{ forloop.counter }}</td>
                      <td class="table-cell">{{item.id}}</td>
                      <td class="table-cell">{{item.name }}</td>
                      <td class="table-cell">{{item.speciality }}</td>
                      <td class="table-cell">{{item.designation }}</td>
                      <td class="table-cell">
                        <!-- JSON data in a hidden script tag -->
                        <script id="chambers-data-{{ item.id }}" type="application/json">
                        {{ item.chambers_json|safe }}
                        </script>
                        <button
                        class="button button--sm button--outline view-chambers-btn"
                        data-doctor-id="{{ item.id }}"
                        data-doctor-name="{{ item.name }}"
                        >
                        View Chambers
                        </button>
                        </td>
                  </tr>
                  {% endfor %}
              </tbody>
              </table>
          </div>

        <!-- pagination -->
        <div class="flex items-center justify-between flex-wrap gap-8 my-3 mt-6">
            <p class="text-muted-foreground text-sm">
                Showing {{ data.start_index }} to {{ data.end_index }} of {{ data.paginator.count }} entries
            </p>

            <div class="flex items-center flex-wrap gap-2 justify-center lg:justify-end">
                <form method="get" class="flex items-center gap-2">
                    <input type="hidden" name="search" value="{{ search_query }}">
                    <input class="input max-w-[100px]" type="number" name="per_page" id="rowsPerPage" min="1" value="{{ per_page }}" onchange="this.form.submit()"> 
                    <input type="hidden" name="page" value="1">
                    <p class="font-semibold text-sm">Rows per page</p>
                </form>

                <!-- page number -->
              <nav aria-label="Page navigation">
                  <ul class="pagination flex items-center flex-wrap gap-2">
                  {% if data.has_previous %}
                      <li >
                      <a class="button button--md button--outline"  href="?page={{ data.previous_page_number }}&per_page={{ per_page }}&search={{ search_query }}"><i data-lucide="chevron-left"></i> Previous</a>
                      </li>
                  {% else %}
                      <button disabled="true" class="button button--md button--outline"> <i data-lucide="chevron-left"></i><span class="page-link"> Previous</span></button>
                  {% endif %}

                  {% for num in data.paginator.page_range %}
                      {% if data.number == num %}
                      <li class="button button--md button--primary">
                          <span class="page-link">{{ num }}</span>
                      </li>
                      {% elif num > data.number|add:'-3' and num < data.number|add:'3' %}
                      <li  class="button button--md button--outline">
                          <a class="page-link" href="?page={{ num }}&per_page={{ per_page }}&search={{ search_query }}">{{ num }}</a>
                      </li>
                      {% endif %}
                  {% endfor %}

                  {% if data.has_next %}
                      <li class="page-item">
                      <a class="button button--md button--outline" href="?page={{ data.next_page_number }}&per_page={{ per_page }}&search={{ search_query }}">Next <i data-lucide="chevron-right"></i> </a>
                      </li>
                  {% else %}
                      <button disabled="true" class="button button--md button--outline"><span>Next</span> <i data-lucide="chevron-right"></i> </button>
                  {% endif %}
                  </ul>
              </nav>
          </div>

        </div>
    </div>
  </div>

 <!-- Modal dialog -->
<dialog id="doctorModal" class="rounded-md p-6 max-w-4xl w-full border border-gray-300 shadow-lg
         top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 fixed z-50 bg-white">
  <div class="flex justify-between items-center mb-4">
    <h3 id="doctorModalTitle" class="text-xl font-semibold">Chambers</h3>
    <button
      type="button"
      aria-label="Close modal"
      onclick="closeDoctorModal()"
      class="text-gray-500 hover:text-gray-700 text-2xl font-bold leading-none"
    >
      &times;
    </button>
  </div>
  <div id="doctorModalContent" class="overflow-auto max-h-[60vh]"></div>
</dialog>

<script>
  (() => {
    const modal = document.getElementById("doctorModal");
    const modalTitle = document.getElementById("doctorModalTitle");
    const modalContent = document.getElementById("doctorModalContent");

    window.openDoctorModal = () => modal.showModal();
    window.closeDoctorModal = () => {
      modalContent.innerHTML = "";
      modal.close();
    };

    document.addEventListener("DOMContentLoaded", () => {
      const buttons = document.querySelectorAll(".view-chambers-btn");

      buttons.forEach(btn => {
        btn.addEventListener("click", () => {
          try {
            const doctorId = btn.dataset.doctorId;
            const doctorName = btn.dataset.doctorName;
            const script = document.getElementById(`chambers-data-${doctorId}`);
            const chambers = JSON.parse(script.textContent.trim());

            modalTitle.textContent = `Chambers of ${doctorName}`;

            if (!Array.isArray(chambers) || chambers.length === 0) {
              modalContent.innerHTML = `<p>No chambers found for Dr. ${doctorName}.</p>`;
            } else {
              let tableHtml = `
                <table class="w-full border-collapse border border-gray-300 text-left text-sm">
                  <thead class="bg-gray-100">
                    <tr>
                      <th class="border border-gray-300 px-2 py-1">#</th>
                      <th class="border border-gray-300 px-2 py-1">Address</th>
                      <th class="border border-gray-300 px-2 py-1">Phone</th>
                      <th class="border border-gray-300 px-2 py-1">District</th>
                      <th class="border border-gray-300 px-2 py-1">Upazila</th>
                      <th class="border border-gray-300 px-2 py-1">Thana</th>
                    </tr>
                  </thead>
                  <tbody>`;

              chambers.forEach((chamber, i) => {
                tableHtml += `
                  <tr>
                    <td class="border border-gray-300 px-2 py-1">${i + 1}</td>
                    <td class="border border-gray-300 px-2 py-1">${chamber.address}</td>
                    <td class="border border-gray-300 px-2 py-1">${chamber.phone}</td>
                    <td class="border border-gray-300 px-2 py-1">${chamber.district}</td>
                    <td class="border border-gray-300 px-2 py-1">${chamber.upazila}</td>
                    <td class="border border-gray-300 px-2 py-1">${chamber.thana}</td>
                  </tr>`;
              });

              tableHtml += "</tbody></table>";
              modalContent.innerHTML = tableHtml;
            }

            openDoctorModal();
          } catch (error) {
            console.error("Failed to parse chambers JSON or render modal:", error);
            alert("Error displaying chambers data. Please check the console.");
          }
        });
      });
    });
  })();
</script>
{%endblock dashboard %}
